<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>Cadwork IFC Viewer PRO</title>
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#e5e7eb"/>
  <style>
    :root{ --bg:#f3f4f6; --panel:#ffffff; --muted:#6b7280; --text:#111827; --line:#e5e7eb; --accent:#2563eb;}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    #app{position:fixed;inset:0;display:grid;grid-template-columns: 1fr 320px; grid-template-rows: auto 1fr; grid-template-areas: "toolbar sidebar" "viewer sidebar";}
    #toolbar{grid-area:toolbar; display:flex;gap:8px; align-items:center; padding:10px; border-bottom:1px solid var(--line); background:#f8fafc; position:sticky; top:0; z-index:10}
    .btn{background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:14px;cursor:pointer}
    .btn:hover{border-color:#cbd5e1}
    .btn[aria-pressed="true"]{outline:2px solid var(--accent)}
    #viewer{grid-area:viewer; position:relative; background:#e5e7eb}
    #sidebar{grid-area:sidebar; display:flex; flex-direction:column; border-left:1px solid var(--line); background:var(--panel)}
    #sidebar header{font-weight:600; padding:10px 12px; border-bottom:1px solid var(--line);}
    .section{padding:10px 12px; border-bottom:1px solid var(--line)}
    .search{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px}
    #tree{flex:1; overflow:auto; padding:8px 12px}
    .node{display:flex; align-items:center; gap:6px; margin:3px 0}
    .node .name{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .small{font-size:12px;color:var(--muted)}
    #help{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50}
    #help .card{width:min(680px,90vw); background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2)}
    #help h2{margin-top:0} #help ul{line-height:1.6}
    #status{position:fixed; left:10px; bottom:10px; background:#fff; border:1px solid var(--line); border-radius:8px; padding:6px 10px; font-size:12px}
    #progress{position:fixed; left:0; right:0; top:0; height:3px; background:#e5e7eb}
    #bar{height:100%; width:0%; background:var(--accent); transition:width .1s}
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker.js'));
    }
  </script>
  <script type="importmap">
  {
    "imports": {
      "web-ifc-viewer": "https://unpkg.com/web-ifc-viewer@0.0.132/dist/ifc.min.js",
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
    }
  }
  </script>
</head>
<body>
<div id="app">
  <div id="toolbar">
    <button id="open" class="btn">Deschide model</button>
    <button id="fit" class="btn">Fit</button>
    <button id="isolate" class="btn">Izolează selecția</button>
    <button id="hide" class="btn">Ascunde selecția</button>
    <button id="unhide" class="btn">Arată tot</button>
    <button id="measure" class="btn" aria-pressed="false">Măsurare</button>
    <button id="screenshot" class="btn">Screenshot</button>
    <button id="helpBtn" class="btn">Ajutor</button>
    <input id="file" hidden type="file" accept=".ifc,.IFC" />
  </div>
  <div id="viewer"></div>
  <aside id="sidebar">
    <header>Inspector</header>
    <div class="section">
      <div><b>Etaje (BuildingStorey)</b></div>
      <div id="storeys" class="small"></div>
    </div>
    <div class="section">
      <div style="display:flex;gap:8px;align-items:center;">
        <b>Categorii IFC</b>
        <span class="small" style="margin-left:auto">Preset:</span>
        <button id="presetStruct" class="btn small">Structură</button>
        <button id="presetFinisaje" class="btn small">Finisaje</button>
      </div>
      <div id="cats" class="small" style="margin-top:6px"></div>
    </div>
    <div class="section">
      <div id="sel" class="small">Selecție: (nimic)</div>
    </div>
    <div id="tree"></div>
  </aside>
</div>

<div id="help">
  <div class="card">
    <h2>Cadwork IFC Viewer PRO — Ghid rapid</h2>
    <ul>
      <li><b>Încărcare:</b> butonul „Deschide model” sau trage fișierul .IFC în fereastră.</li>
      <li><b>Inspector:</b> bifează <i>Etaje</i> și <i>Categorii</i> pentru a ascunde/arăta rapid. Preset <i>Structură</i> / <i>Finisaje</i>.</li>
      <li><b>Măsurare:</b> activează „Măsurare”, apoi tap pe două puncte din scenă (se vede distanța). „Măsurare” din nou pentru a ieși.</li>
      <li><b>Selecție:</b> click pe element → „Izolează selecția” sau „Ascunde selecția”. „Arată tot” revine la vizibil.</li>
      <li><b>Screenshot:</b> salvează imaginea actuală ca PNG.</li>
      <li><b>Offline:</b> după prima deschidere, aplicația funcționează și fără internet.</li>
    </ul>
    <div style="text-align:right;margin-top:8px">
      <button id="closeHelp" class="btn">Închide</button>
    </div>
  </div>
</div>

<div id="status">Gata — încarcă un fișier .IFC</div>
<div id="progress"><div id="bar"></div></div>

<script type="module">
import { IfcViewerAPI } from 'web-ifc-viewer';
import * as THREE from 'three';

async function main(){
  const container = document.getElementById('viewer');
  const viewer = new IfcViewerAPI({ container, backgroundColor: new THREE.Color(0xe5e7eb) });
  // NO top-level await; wait inside main
  try{ await viewer.IFC.setWasmPath("https://unpkg.com/web-ifc@0.0.43/"); }catch(e){ console.error('WASM path set error', e); }
  viewer.grid.setGrid(); viewer.axes.setAxes();

  // UI refs
  const fileIn = document.getElementById('file');
  const openBtn = document.getElementById('open');
  const fitBtn = document.getElementById('fit');
  const isolateBtn = document.getElementById('isolate');
  const hideBtn = document.getElementById('hide');
  const unhideBtn = document.getElementById('unhide');
  const measureBtn = document.getElementById('measure');
  const screenshotBtn = document.getElementById('screenshot');
  const statusEl = document.getElementById('status'); 
  const bar = document.getElementById('bar');
  const help = document.getElementById('help'); 
  const helpBtn = document.getElementById('helpBtn'); 
  const closeHelp = document.getElementById('closeHelp');
  const storeysEl = document.getElementById('storeys'); 
  const catsEl = document.getElementById('cats'); 
  const selEl = document.getElementById('sel');

  let modelID=null, lastSelection=null, measuring=false, measurePts=[], measureLine=null;

  // progress (guarded)
  try{
    viewer.IFC.loader.ifcManager.state.api.onProgress = (p)=>{ try{ bar.style.width=(p*100).toFixed(1)+'%'; }catch{} };
  }catch{}

  const setStatus=(t)=> statusEl.textContent=t;

  // File open
  openBtn.addEventListener('click', ()=> { console.log('Buton apăsat: Deschide model'); fileIn.click(); });
  fileIn.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if (f) await loadIfc(f); });

  // Drag & drop
  const stop=(e)=>{ e.preventDefault(); e.stopPropagation(); };
  ['dragenter','dragover','dragleave','drop'].forEach(ev=>{ window.addEventListener(ev, stop, {passive:false}); document.body.addEventListener(ev, stop, {passive:false}); });
  document.addEventListener('drop', async (e)=>{ const f=e.dataTransfer?.files?.[0]; if (f) await loadIfc(f); }, {passive:false});

  async function loadIfc(file){
    setStatus('Se încarcă '+file.name+' ...');
    const model = await viewer.IFC.loadIfcFile(file, true);
    modelID = model.modelID;
    viewer.shadowDropper.darkness = 0.25;
    viewer.shadowDropper.renderShadow(model.mesh);
    await buildInspector();
    setStatus('Încărcat: '+file.name);
  }

  // Inspector
  async function buildInspector(){
    const spatial = await viewer.IFC.getSpatialStructure(modelID);
    storeysEl.innerHTML='';
    const storeyNodes=[];
    (function walk(n){ if (!n) return; if (n.type==='IFCBUILDINGSTOREY') storeyNodes.push(n); (n.children||[]).forEach(walk); })(spatial);
    storeyNodes.forEach(st=>{
      const label=document.createElement('label'); label.style.display='block';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.dataset.storey=st.expressID;
      cb.onchange = ()=> toggleStorey(st.expressID, cb.checked);
      label.appendChild(cb); const span=document.createElement('span'); span.textContent=' '+(st.name || ('Storey '+st.expressID));
      label.appendChild(span); storeysEl.appendChild(label);
    });

    const IFC = viewer.IFC.loader.ifcManager.types;
    const CATS = [
      'IFCWALL','IFCSLAB','IFCBEAM','IFCCOLUMN','IFCROOF','IFCPLATE','IFCMEMBER',
      'IFCWINDOW','IFCDOOR','IFCCOVERING','IFCFURNISHINGELEMENT','IFCRAILING','IFCRAMP','IFCSTAIR'
    ].filter(k=> IFC[k] !== undefined);

    catsEl.innerHTML='';
    for (const cat of CATS){
      const type = IFC[cat];
      const ids = await viewer.IFC.loader.ifcManager.getAllItemsOfType(modelID, type, false);
      if (!ids.length) continue;
      const label=document.createElement('label'); label.style.display='block';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.dataset.cat=type;
      cb.onchange = ()=> toggleCategory(type, cb.checked);
      label.appendChild(cb);
      const span=document.createElement('span'); span.textContent=' '+cat+' ('+ids.length+')';
      label.appendChild(span);
      catsEl.appendChild(label);
    }

    document.getElementById('presetStruct').onclick = ()=>{
      catsEl.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        const row = cb.nextSibling.textContent;
        const keep = /(WALL|SLAB|BEAM|COLUMN|ROOF|PLATE|MEMBER)/.test(row);
        cb.checked = keep;
        toggleCategory(parseInt(cb.dataset.cat), keep, false);
      });
      viewer.context.renderer.postProduction.update();
    };
    document.getElementById('presetFinisaje').onclick = ()=>{
      catsEl.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        const row = cb.nextSibling.textContent;
        const keep = /(WINDOW|DOOR|COVERING|FURNISHING)/.test(row);
        cb.checked = keep;
        toggleCategory(parseInt(cb.dataset.cat), keep, false);
      });
      viewer.context.renderer.postProduction.update();
    };
  }

  async function toggleStorey(storeyId, visible){
    const rels = await viewer.IFC.getSpatialStructure(modelID);
    const targets=[];
    (function collect(node, active){
      const isStorey = node.type==='IFCBUILDINGSTOREY' && node.expressID===storeyId;
      const nowActive = active || isStorey;
      (node.children||[]).forEach(ch=>{
        if (nowActive && ch.expressID) targets.push(ch.expressID);
        collect(ch, nowActive);
      });
    })(rels,false);
    if (visible) await viewer.IFC.showItems(modelID, targets);
    else await viewer.IFC.hideItems(modelID, targets);
  }

  async function toggleCategory(type, visible, update=true){
    if (visible) await viewer.IFC.showAllItemsOfType(modelID, type);
    else {
      const ids = await viewer.IFC.loader.ifcManager.getAllItemsOfType(modelID, type, false);
      await viewer.IFC.hideItems(modelID, ids.map(x=>x.expressID||x));
    }
    if (update) viewer.context.renderer.postProduction.update();
  }

  // Selection
  window.onpointerdown = async ()=>{
    const res = await viewer.IFC.selector.pickIfcItem();
    if (!res) { lastSelection=null; selEl.textContent='Selecție: (nimic)'; return; }
    lastSelection = res;
    selEl.textContent = 'Selecție: '+res.type+' #'+res.expressID;
  };
  isolateBtn.onclick = ()=>{ if (lastSelection) viewer.IFC.selector.isolateSelection(); };
  hideBtn.onclick = async ()=>{
    if (!lastSelection) return;
    await viewer.IFC.hideItems(lastSelection.modelID, [lastSelection.expressID]);
    lastSelection=null; selEl.textContent='Selecție: (nimic)';
  };
  unhideBtn.onclick = async ()=>{ await viewer.IFC.showAllItems(modelID); };

  fitBtn.onclick = ()=> viewer.context.ifcCamera.fitModelToFrame();

  // Measure (two points)
  measureBtn.onclick = ()=>{ measuring=!measuring; measureBtn.setAttribute('aria-pressed', measuring); if (!measuring) clearMeasure(); };
  function clearMeasure(){
    measurePts=[];
    if (measureLine){ viewer.context.getScene().remove(measureLine); measureLine=null; }
    setStatus('Măsurare oprită');
  }
  window.addEventListener('click', async (e)=>{
    if (!measuring) return;
    const result = await viewer.context.castRayIfc();
    if(!result) return;
    const pt = result.point;
    measurePts.push(pt);
    if (measurePts.length===2){
      const g = new THREE.BufferGeometry().setFromPoints(measurePts);
      const m = new THREE.LineBasicMaterial({ color: 0x2563eb });
      if (measureLine) viewer.context.getScene().remove(measureLine);
      measureLine = new THREE.Line(g, m);
      viewer.context.getScene().add(measureLine);
      const d = measurePts[0].distanceTo(measurePts[1]);
      setStatus('Distanță: '+(d*1000).toFixed(1)+' mm');
      measurePts=[];
    } else {
      setStatus('Primul punct selectat. Alege al doilea punct…');
    }
  });

  screenshotBtn.onclick = ()=>{
    const link = document.createElement('a');
    link.download='screenshot.png';
    link.href = viewer.context.renderer.getCanvas().toDataURL('image/png');
    link.click();
  };

  // Help overlay
  helpBtn.onclick = ()=> help.style.display='flex';
  closeHelp.onclick = ()=> help.style.display='none';

  // Adaptive pixel ratio
  const renderer = viewer.context.renderer;
  renderer.renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 1.5));
}

// start
main().catch(err=>{
  console.error('Init error:', err);
  alert('Eroare la inițializare. Verifică dacă browserul suportă module ES și import maps.');
});
</script>
</body>
</html>
